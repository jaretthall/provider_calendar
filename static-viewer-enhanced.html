<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinica Provider Schedule - Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .shift-badge {
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 22px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 6px;
            margin-bottom: 1px;
            cursor: pointer;
        }
        .shift-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            z-index: 10;
        }
        .vacation-bar {
            background-color: #dc2626 !important;
            color: white;
            font-weight: 600;
            min-height: 18px;
            border-radius: 2px;
            margin-top: auto;
        }
        .filter-item {
            transition: all 0.2s ease;
        }
        .filter-item.disabled {
            opacity: 0.5;
        }
        .ma-badge {
            background-color: rgba(255,255,255,0.3);
            color: inherit;
            font-size: 9px;
            padding: 1px 3px;
            border-radius: 2px;
            margin-left: 2px;
            display: inline-block;
        }
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 300px;
        }
        .tooltip.show {
            opacity: 1;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0,0,0,0.95) transparent transparent transparent;
        }
        /* Current view styling */
        .view-btn-active {
            background-color: #3b82f6 !important;
            color: white !important;
        }
        .view-btn-inactive {
            background-color: #e5e7eb !important;
            color: #6b7280 !important;
        }
        .provider-color-dot, .clinic-color-dot, .ma-color-dot {
            border: 2px solid rgba(255,255,255,0.3);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-72 bg-gray-800 text-white shadow-lg border-r flex flex-col">
            <!-- Sidebar Header -->
            <div class="p-3 border-b border-gray-700 bg-gray-900">
                <div class="flex items-center space-x-2 mb-2">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <h1 class="text-base font-bold">Clinica Provider Schedule</h1>
                </div>
                <span class="bg-green-600 text-white text-xs px-3 py-1 rounded font-medium">VIEWER ONLY</span>
            </div>

            <!-- Filters Section -->
            <div class="flex-1 p-3 space-y-5">
                <!-- View Options -->
                <div>
                    <h4 class="text-xs font-medium text-gray-300 uppercase tracking-wide mb-2">View Options</h4>
                    <label class="flex items-center space-x-2 text-sm text-gray-200 cursor-pointer">
                        <input type="checkbox" id="show-vacations" checked class="rounded text-blue-500">
                        <span>Show Vacations/Time-off</span>
                    </label>
                </div>

                <!-- Providers Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-medium text-white flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                            </svg>
                            Providers
                        </h4>
                        <button onclick="toggleAllProviders()" class="text-xs text-blue-400 hover:text-blue-300">Toggle All</button>
                    </div>
                    <div id="providers-list" class="space-y-1">
                        <!-- Providers will be populated here -->
                    </div>
                </div>

                <!-- Medical Assistants Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-medium text-white flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 616 0zM17 6a3 3 0 11-6 0 3 3 0 616 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 515 5v1H1v-1a5 5 0 515-5z"></path>
                            </svg>
                            Medical Assistants
                        </h4>
                        <button onclick="toggleAllMAs()" class="text-xs text-blue-400 hover:text-blue-300">Toggle All</button>
                    </div>
                    <div id="medical-assistants-list" class="space-y-1">
                        <!-- Medical assistants will be populated here -->
                    </div>
                </div>

                <!-- Clinic Types Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-medium text-white flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                            </svg>
                            Clinic Types
                        </h4>
                        <button onclick="toggleAllClinics()" class="text-xs text-blue-400 hover:text-blue-300">Toggle All</button>
                    </div>
                    <div id="clinic-types-list" class="space-y-1">
                        <!-- Clinic types will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm p-4 border-b">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="navigateMonth(-1)" class="p-2 rounded-full hover:bg-gray-100 transition-colors" title="Previous month">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h2 id="current-month" class="text-xl font-semibold text-gray-800"></h2>
                        <button onclick="navigateMonth(1)" class="p-2 rounded-full hover:bg-gray-100 transition-colors" title="Next month">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex rounded-lg bg-gray-100 p-1">
                            <button id="month-btn" onclick="setView('month')" class="px-3 py-1 text-sm font-medium view-btn-active rounded transition-colors">Month</button>
                            <button id="week-btn" onclick="setView('week')" class="px-3 py-1 text-sm font-medium view-btn-inactive rounded transition-colors">Week</button>
                            <button id="day-btn" onclick="setView('day')" class="px-3 py-1 text-sm font-medium view-btn-inactive rounded transition-colors">Day</button>
                        </div>
                        <button onclick="goToToday()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-medium transition-colors">Today</button>
                    </div>
                </div>
            </header>

            <!-- Loading State -->
            <div id="loading" class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-3 text-gray-600">Loading schedule data...</p>
                </div>
            </div>

            <!-- Error State -->
            <div id="error" class="hidden flex-1 flex items-center justify-center">
                <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-md">
                    <div class="flex">
                        <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Unable to load schedule data</h3>
                            <p class="mt-1 text-sm text-red-700" id="error-message"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div id="calendar" class="hidden flex-1 overflow-auto bg-white">
                <!-- Calendar will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="bg-gray-800 text-gray-300 py-2 px-4 text-xs text-center border-t border-gray-700">
        <span>Clinica Provider Schedule - Static Viewer v1.0.8</span>
        <span class="mx-2">‚Ä¢</span>
        <span id="connection-status">Connected to Supabase</span>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://fgqhclnsndiwdecxvcxi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZncWhjbG5zbmRpd2RlY3h2Y3hpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1ODQ4ODYsImV4cCI6MjA2NTE2MDg4Nn0.Q5KbeUgj4buVQL1SE4K1YB6cVpKf3MxNRAw0w-8Uzug';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // CRITICAL FIX: Tailwind color class to hex color mapping
        // This matches the dynamic app's color handling
        const TAILWIND_COLOR_MAP = {
          // Reds
          'bg-red-500': '#ef4444',
          'bg-red-600': '#dc2626',
          // Oranges
          'bg-orange-500': '#f97316',
          'bg-orange-400': '#fb923c',
          // Ambers
          'bg-amber-500': '#f59e0b',
          'bg-amber-400': '#fbbf24',
          // Yellows
          'bg-yellow-500': '#eab308',
          'bg-yellow-400': '#facc15',
          // Limes
          'bg-lime-500': '#84cc16',
          'bg-lime-600': '#65a30d',
          // Greens
          'bg-green-500': '#22c55e',
          'bg-green-600': '#16a34a',
          // Emeralds
          'bg-emerald-500': '#10b981',
          'bg-emerald-400': '#34d399',
          // Teals
          'bg-teal-500': '#14b8a6',
          'bg-teal-600': '#0d9488',
          // Cyans
          'bg-cyan-500': '#06b6d4',
          'bg-cyan-400': '#22d3ee',
          // Skies
          'bg-sky-500': '#0ea5e9',
          'bg-sky-600': '#0284c7',
          // Blues
          'bg-blue-500': '#3b82f6',
          'bg-blue-600': '#2563eb',
          // Indigos
          'bg-indigo-500': '#6366f1',
          'bg-indigo-400': '#818cf8',
          // Violets
          'bg-violet-500': '#8b5cf6',
          'bg-violet-600': '#7c3aed',
          // Purples
          'bg-purple-500': '#a855f7',
          'bg-purple-600': '#9333ea',
          // Fuchsias
          'bg-fuchsia-500': '#d946ef',
          'bg-fuchsia-400': '#e879f9',
          // Pinks
          'bg-pink-500': '#ec4899',
          'bg-pink-400': '#f472b6',
          // Roses
          'bg-rose-500': '#f43f5e',
          'bg-rose-400': '#fb7185',
          // Grays/Neutrals
          'bg-slate-500': '#64748b',
          'bg-gray-500': '#6b7280',
          'bg-gray-600': '#4b5563'
        };

        // Convert Tailwind color class to actual hex value
        function getActualColor(colorClass) {
            // If it's already a hex color, return as-is
            if (colorClass && colorClass.startsWith('#')) {
                return colorClass;
            }
            
            // Convert Tailwind class to hex
            return TAILWIND_COLOR_MAP[colorClass] || '#6b7280'; // Default gray if not found
        }

        // Global state
        let currentDate = new Date();
        let allData = {
            providers: [],
            clinicTypes: [],
            medicalAssistants: [],
            shifts: []
        };

        // Filter state
        let filters = {
            providers: new Set(),
            medicalAssistants: new Set(),
            clinicTypes: new Set(),
            showVacations: true
        };

        // Initialize the viewer
        async function init() {
            try {
                await loadAllData();
                initializeFilters();
                renderCalendar();
                hideLoading();
                console.log('‚úÖ Static viewer loaded successfully with color mapping');
            } catch (error) {
                console.error('‚ùå Error loading static viewer:', error);
                showError(error.message);
            }
        }

        // Load all data from Supabase
        async function loadAllData() {
            const [providersRes, clinicsRes, masRes, shiftsRes] = await Promise.all([
                supabase.from('providers').select('*').eq('is_active', true),
                supabase.from('clinic_types').select('*').eq('is_active', true),
                supabase.from('medical_assistants').select('*').eq('is_active', true),
                supabase.from('shifts').select('*')
            ]);

            if (providersRes.error) throw new Error('Failed to load providers: ' + providersRes.error.message);
            if (clinicsRes.error) throw new Error('Failed to load clinic types: ' + clinicsRes.error.message);
            if (masRes.error) throw new Error('Failed to load medical assistants: ' + masRes.error.message);
            if (shiftsRes.error) throw new Error('Failed to load shifts: ' + shiftsRes.error.message);

            allData.providers = providersRes.data || [];
            allData.clinicTypes = clinicsRes.data || [];
            allData.medicalAssistants = masRes.data || [];
            allData.shifts = shiftsRes.data || [];

            console.log('üìä Data loaded:', {
                providers: allData.providers.length,
                clinicTypes: allData.clinicTypes.length, 
                medicalAssistants: allData.medicalAssistants.length,
                shifts: allData.shifts.length
            });

            // Initialize all filters as enabled
            allData.providers.forEach(p => filters.providers.add(p.id));
            allData.medicalAssistants.forEach(ma => filters.medicalAssistants.add(ma.id));
            allData.clinicTypes.forEach(ct => filters.clinicTypes.add(ct.id));
        }

        // Initialize filter UI with proper color display
        function initializeFilters() {
            // Setup vacation filter
            document.getElementById('show-vacations').addEventListener('change', (e) => {
                filters.showVacations = e.target.checked;
                renderCalendar();
            });

            // Render provider filters with color dots
            const providersContainer = document.getElementById('providers-list');
            providersContainer.innerHTML = allData.providers.map(provider => `
                <label class="flex items-center space-x-3 p-2 rounded hover:bg-gray-700 cursor-pointer filter-item transition-colors">
                    <input type="checkbox" checked onchange="toggleProvider('${provider.id}')" class="rounded text-blue-400">
                    <div class="w-4 h-4 rounded-full provider-color-dot" style="background-color: ${getActualColor(provider.color)}"></div>
                    <span class="text-sm text-gray-200 flex-1">${provider.name}</span>
                </label>
            `).join('');

            // Render medical assistant filters with color dots
            const masContainer = document.getElementById('medical-assistants-list');
            masContainer.innerHTML = allData.medicalAssistants.map(ma => `
                <label class="flex items-center space-x-3 p-2 rounded hover:bg-gray-700 cursor-pointer filter-item transition-colors">
                    <input type="checkbox" checked onchange="toggleMA('${ma.id}')" class="rounded text-blue-400">
                    <div class="w-4 h-4 rounded-full ma-color-dot" style="background-color: ${getActualColor(ma.color)}"></div>
                    <span class="text-sm text-gray-200 flex-1">${ma.name}</span>
                </label>
            `).join('');

            // Render clinic type filters with color dots
            const clinicsContainer = document.getElementById('clinic-types-list');
            clinicsContainer.innerHTML = allData.clinicTypes.map(clinic => `
                <label class="flex items-center space-x-3 p-2 rounded hover:bg-gray-700 cursor-pointer filter-item transition-colors">
                    <input type="checkbox" checked onchange="toggleClinic('${clinic.id}')" class="rounded text-blue-400">
                    <div class="w-4 h-4 rounded-full clinic-color-dot" style="background-color: ${getActualColor(clinic.color)}"></div>
                    <span class="text-sm text-gray-200 flex-1">${clinic.name}</span>
                </label>
            `).join('');
        }

        // Filter functions
        function toggleProvider(id) {
            if (filters.providers.has(id)) {
                filters.providers.delete(id);
            } else {
                filters.providers.add(id);
            }
            renderCalendar();
        }

        function toggleMA(id) {
            if (filters.medicalAssistants.has(id)) {
                filters.medicalAssistants.delete(id);
            } else {
                filters.medicalAssistants.add(id);
            }
            renderCalendar();
        }

        function toggleClinic(id) {
            if (filters.clinicTypes.has(id)) {
                filters.clinicTypes.delete(id);
            } else {
                filters.clinicTypes.add(id);
            }
            renderCalendar();
        }

        function toggleAllProviders() {
            const allChecked = allData.providers.every(p => filters.providers.has(p.id));
            if (allChecked) {
                filters.providers.clear();
            } else {
                allData.providers.forEach(p => filters.providers.add(p.id));
            }
            updateFilterUI();
            renderCalendar();
        }

        function toggleAllMAs() {
            const allChecked = allData.medicalAssistants.every(ma => filters.medicalAssistants.has(ma.id));
            if (allChecked) {
                filters.medicalAssistants.clear();
            } else {
                allData.medicalAssistants.forEach(ma => filters.medicalAssistants.add(ma.id));
            }
            updateFilterUI();
            renderCalendar();
        }

        function toggleAllClinics() {
            const allChecked = allData.clinicTypes.every(ct => filters.clinicTypes.has(ct.id));
            if (allChecked) {
                filters.clinicTypes.clear();
            } else {
                allData.clinicTypes.forEach(ct => filters.clinicTypes.add(ct.id));
            }
            updateFilterUI();
            renderCalendar();
        }

        function updateFilterUI() {
            // Update provider checkboxes
            document.querySelectorAll('#providers-list input[type="checkbox"]').forEach((checkbox, index) => {
                checkbox.checked = filters.providers.has(allData.providers[index].id);
            });

            // Update MA checkboxes
            document.querySelectorAll('#medical-assistants-list input[type="checkbox"]').forEach((checkbox, index) => {
                checkbox.checked = filters.medicalAssistants.has(allData.medicalAssistants[index].id);
            });

            // Update clinic checkboxes
            document.querySelectorAll('#clinic-types-list input[type="checkbox"]').forEach((checkbox, index) => {
                checkbox.checked = filters.clinicTypes.has(allData.clinicTypes[index].id);
            });
        }

        // Render the calendar
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update header
            document.getElementById('current-month').textContent = 
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Generate calendar grid
            const calendarHTML = `
                <div class="grid grid-cols-7 gap-px border-l border-t border-gray-200 bg-gray-200">
                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => 
                        `<div class="py-3 text-center font-semibold text-sm text-gray-600 bg-gray-50">${day}</div>`
                    ).join('')}
                </div>
                <div class="grid grid-cols-7 auto-rows-fr gap-px bg-gray-200" style="min-height: calc(100vh - 200px);">
                    ${generateCalendarDays(year, month)}
                </div>
            `;
            
            document.getElementById('calendar').innerHTML = calendarHTML;
        }

        // Generate calendar days
        function generateCalendarDays(year, month) {
            const firstDay = new Date(year, month, 1);
            const startOfWeek = new Date(firstDay);
            startOfWeek.setDate(firstDay.getDate() - firstDay.getDay());
            
            let daysHTML = '';
            let currentDay = new Date(startOfWeek);
            
            // Generate 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
                const isCurrentMonth = currentDay.getMonth() === month;
                const isToday = isToday_check(currentDay);
                const dayShifts = getShiftsForDate(currentDay);
                
                daysHTML += `
                    <div class="relative flex flex-col p-2 min-h-[120px] ${
                        isCurrentMonth ? 'bg-white' : 'bg-gray-50 text-gray-400'
                    } ${isToday ? 'bg-blue-50 border-2 border-blue-200' : ''}">
                        <div class="text-sm font-medium ${isToday ? 'text-blue-600' : ''} mb-2">
                            ${currentDay.getDate()}
                        </div>
                        <div class="flex-1 space-y-1">
                            ${renderDayShifts(dayShifts, currentDay)}
                        </div>
                    </div>
                `;
                
                currentDay.setDate(currentDay.getDate() + 1);
            }
            
            return daysHTML;
        }

        // Render shifts for a specific day
        function renderDayShifts(shifts, date) {
            const filteredShifts = shifts.filter(shift => {
                // Apply filters
                if (!filters.showVacations && shift.is_vacation) return false;
                if (!filters.providers.has(shift.provider_id)) return false;
                if (shift.clinic_type_id && !filters.clinicTypes.has(shift.clinic_type_id)) return false;
                
                // Check if any MA matches filter (for non-vacation shifts)
                if (!shift.is_vacation && shift.medical_assistant_ids && shift.medical_assistant_ids.length > 0) {
                    const hasVisibleMA = shift.medical_assistant_ids.some(maId => filters.medicalAssistants.has(maId));
                    if (!hasVisibleMA) return false;
                }
                
                return true;
            });

            const nonVacationShifts = filteredShifts.filter(s => !s.is_vacation);
            const vacationShifts = filteredShifts.filter(s => s.is_vacation);
            
            let html = '';
            
            // Show up to 4 non-vacation shifts
            const shiftsToShow = nonVacationShifts.slice(0, 4);
            shiftsToShow.forEach(shift => {
                const provider = allData.providers.find(p => p.id === shift.provider_id);
                const clinic = allData.clinicTypes.find(c => c.id === shift.clinic_type_id);
                const mas = (shift.medical_assistant_ids || []).map(maId => 
                    allData.medicalAssistants.find(ma => ma.id === maId)
                ).filter(ma => ma);
                
                const tooltipText = `<strong>${provider?.name || 'Unknown Provider'}</strong>${clinic ? `\nüìç ${clinic.name}` : ''}${shift.start_time ? `\n‚è∞ ${shift.start_time} - ${shift.end_time}` : ''}${mas.length > 0 ? `\nüë• MA: ${mas.map(ma => ma.name).join(', ')}` : ''}${shift.notes ? `\nüìù ${shift.notes}` : ''}`;
                
                html += `
                    <div class="shift-badge text-white" 
                         style="background-color: ${getActualColor(provider?.color || 'bg-gray-500')}"
                         onmouseenter="showTooltip(event, '${tooltipText.replace(/'/g, '&apos;')}')"
                         onmouseleave="hideTooltip()">
                        ${getInitials(provider?.name || '??')}${mas.length > 0 ? mas.map(ma => `<span class="ma-badge">${getInitials(ma.name)}</span>`).join('') : ''}
                    </div>
                `;
            });
            
            // Show "more" indicator if there are additional shifts
            if (nonVacationShifts.length > 4) {
                html += `
                    <div class="text-xs text-blue-600 text-center font-medium">
                        +${nonVacationShifts.length - 4} more
                    </div>
                `;
            }
            
            // Show vacation bar at bottom if there are vacations
            if (vacationShifts.length > 0) {
                const vacationInitials = vacationShifts.map(shift => {
                    const provider = allData.providers.find(p => p.id === shift.provider_id);
                    return getInitials(provider?.name || '??');
                });
                
                html += `
                    <div class="vacation-bar text-xs text-center"
                         title="Vacation/Time-off: ${vacationShifts.map(s => allData.providers.find(p => p.id === s.provider_id)?.name || 'Unknown').join(', ')}">
                        ${vacationInitials.join(' ')}
                    </div>
                `;
            }
            
            return html;
        }

        // Utility functions
        function getInitials(name) {
            return name.split(' ').map(word => word[0]).join('').toUpperCase();
        }

        function isToday_check(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function getShiftsForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            return allData.shifts.filter(shift => 
                shift.start_date <= dateStr && shift.end_date >= dateStr
            );
        }

        // Navigation functions
        function navigateMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        // UI state functions
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('calendar').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        // Global variables for tooltip and views
        let currentView = 'month';
        let currentWeekStart = new Date();
        let currentDayDate = new Date();
        let tooltip = null;

        // Tooltip functions
        function showTooltip(event, text) {
            hideTooltip();
            tooltip = document.createElement('div');
            tooltip.className = 'tooltip show';
            tooltip.innerHTML = text.replace(/\n/g, '<br>');
            document.body.appendChild(tooltip);
            
            const rect = event.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            // Position tooltip above the element by default
            let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
            let top = rect.top - tooltipRect.height - 10;
            
            // Adjust if tooltip would go off screen
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) {
                top = rect.bottom + 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function hideTooltip() {
            if (tooltip) {
                tooltip.remove();
                tooltip = null;
            }
        }

        // View switching functions
        function setView(view) {
            currentView = view;
            updateViewButtons();
            
            if (view === 'month') {
                renderCalendar();
            } else if (view === 'week') {
                renderWeekView();
            } else if (view === 'day') {
                renderDayView();
            }
        }

        function updateViewButtons() {
            document.getElementById('month-btn').className = 
                currentView === 'month' ? 'px-3 py-1 text-sm font-medium view-btn-active rounded transition-colors' : 'px-3 py-1 text-sm font-medium view-btn-inactive rounded transition-colors';
            document.getElementById('week-btn').className = 
                currentView === 'week' ? 'px-3 py-1 text-sm font-medium view-btn-active rounded transition-colors' : 'px-3 py-1 text-sm font-medium view-btn-inactive rounded transition-colors';
            document.getElementById('day-btn').className = 
                currentView === 'day' ? 'px-3 py-1 text-sm font-medium view-btn-active rounded transition-colors' : 'px-3 py-1 text-sm font-medium view-btn-inactive rounded transition-colors';
        }

        // Week view rendering
        function renderWeekView() {
            const weekStart = getWeekStart(currentDate);
            currentWeekStart = new Date(weekStart);
            
            document.getElementById('current-month').textContent = 
                `${currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(currentWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

            const calendarHTML = `
                <div class="grid grid-cols-8 gap-px bg-gray-200">
                    <div class="bg-gray-50 p-2"></div>
                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, index) => {
                        const date = new Date(weekStart.getTime() + index * 24 * 60 * 60 * 1000);
                        return `<div class="bg-gray-50 p-2 text-center font-semibold text-sm">
                            <div>${day}</div>
                            <div class="text-lg ${isToday_check(date) ? 'text-blue-600 font-bold' : ''}">${date.getDate()}</div>
                        </div>`;
                    }).join('')}
                    ${generateWeekRows()}
                </div>
            `;
            
            document.getElementById('calendar').innerHTML = calendarHTML;
        }

        function generateWeekRows() {
            let html = '';
            for (let hour = 6; hour <= 22; hour++) {
                const timeStr = hour <= 12 ? `${hour}:00 AM` : `${hour - 12}:00 PM`;
                if (hour === 12) timeStr = '12:00 PM';
                
                html += `
                    <div class="bg-white p-2 text-xs text-gray-500 font-medium border-r">${timeStr}</div>
                `;
                
                for (let day = 0; day < 7; day++) {
                    const date = new Date(currentWeekStart.getTime() + day * 24 * 60 * 60 * 1000);
                    const dayShifts = getShiftsForDate(date).filter(shift => {
                        if (shift.start_time && shift.end_time) {
                            const startHour = parseInt(shift.start_time.split(':')[0]);
                            const endHour = parseInt(shift.end_time.split(':')[0]);
                            return startHour <= hour && endHour > hour;
                        }
                        return false;
                    });
                    
                    html += `<div class="bg-white p-1 min-h-[30px] border-r">
                        ${renderWeekShifts(dayShifts)}
                    </div>`;
                }
            }
            return html;
        }

        function renderWeekShifts(shifts) {
            const filteredShifts = shifts.filter(shift => {
                if (!filters.showVacations && shift.is_vacation) return false;
                if (!filters.providers.has(shift.provider_id)) return false;
                if (shift.clinic_type_id && !filters.clinicTypes.has(shift.clinic_type_id)) return false;
                return true;
            });

            return filteredShifts.map(shift => {
                const provider = allData.providers.find(p => p.id === shift.provider_id);
                const clinic = allData.clinicTypes.find(c => c.id === shift.clinic_type_id);
                const mas = (shift.medical_assistant_ids || []).map(maId => 
                    allData.medicalAssistants.find(ma => ma.id === maId)
                ).filter(ma => ma);
                
                const tooltipText = `<strong>${provider?.name || 'Unknown Provider'}</strong>${clinic ? `\nüìç ${clinic.name}` : ''}${shift.start_time ? `\n‚è∞ ${shift.start_time} - ${shift.end_time}` : ''}${mas.length > 0 ? `\nüë• MA: ${mas.map(ma => ma.name).join(', ')}` : ''}${shift.notes ? `\nüìù ${shift.notes}` : ''}`;
                
                return `
                    <div class="shift-badge text-white text-xs mb-1" 
                         style="background-color: ${getActualColor(provider?.color || 'bg-gray-500')}"
                         onmouseenter="showTooltip(event, '${tooltipText.replace(/'/g, '&apos;')}')"
                         onmouseleave="hideTooltip()">
                        ${getInitials(provider?.name || '??')} ${mas.map(ma => ma.name).join(', ')}
                    </div>
                `;
            }).join('');
        }

        // Day view rendering
        function renderDayView() {
            currentDayDate = new Date(currentDate);
            
            document.getElementById('current-month').textContent = 
                currentDayDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

            const calendarHTML = `
                <div class="grid grid-cols-2 gap-px bg-gray-200 h-full">
                    <div class="bg-gray-50 p-2 text-center font-semibold">Time</div>
                    <div class="bg-gray-50 p-2 text-center font-semibold">${currentDayDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</div>
                    ${generateDayHours()}
                </div>
            `;
            
            document.getElementById('calendar').innerHTML = calendarHTML;
        }

        function generateDayHours() {
            let html = '';
            for (let hour = 6; hour <= 22; hour++) {
                const timeStr = hour === 0 ? '12:00 AM' : hour <= 12 ? `${hour}:00 AM` : `${hour - 12}:00 PM`;
                if (hour === 12) timeStr = '12:00 PM';
                
                const hourShifts = getShiftsForDate(currentDayDate).filter(shift => {
                    if (shift.start_time && shift.end_time) {
                        const startHour = parseInt(shift.start_time.split(':')[0]);
                        const endHour = parseInt(shift.end_time.split(':')[0]);
                        return startHour <= hour && endHour > hour;
                    }
                    return false;
                });
                
                html += `
                    <div class="bg-white p-2 text-xs text-gray-500 font-medium border-r">${timeStr}</div>
                    <div class="bg-white p-1 min-h-[40px] border-r">
                        ${renderWeekShifts(hourShifts)}
                    </div>
                `;
            }
            return html;
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        // Navigation functions updated for different views
        function navigateMonth(direction) {
            if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
                renderCalendar();
            } else if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
                renderWeekView();
            } else if (currentView === 'day') {
                currentDate.setDate(currentDate.getDate() + direction);
                renderDayView();
            }
        }

        function goToToday() {
            currentDate = new Date();
            if (currentView === 'month') {
                renderCalendar();
            } else if (currentView === 'week') {
                renderWeekView();
            } else if (currentView === 'day') {
                renderDayView();
            }
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html> 